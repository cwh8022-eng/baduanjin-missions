<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>八段錦 AI 闖關 — 單頁版（PWA）</title>
  <!-- PWA 基本設定（若專案已有 manifest / sw.js 可保留；沒有也不影響鏡頭顯示修正） -->
  <meta name="theme-color" content="#ef7d4d" />
  <link rel="manifest" href="manifest.webmanifest">
  <link rel="icon" href="assets/icons/icon-192.png" sizes="192x192">
  <link rel="apple-touch-icon" href="assets/icons/icon-192.png">
  <!-- UI：Tailwind（正式上線可改用編譯後 CSS 以消除「不建議 production」警告） -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- AI：TFJS + Teachable Machine Pose（與 TM 0.8 最穩定組合） -->
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@1.3.1/dist/tf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/pose@0.8/dist/teachablemachine-pose.min.js"></script>
  <style>
    :root { --ink:#0f172a; --paper:#f8fafc; --brand:#ef7d4d; --ok:#16a34a; --warn:#f59e0b; --danger:#ef4444; }
    body{background:var(--paper); color:var(--ink)}
    .card{background:#fff; border-radius:1rem; box-shadow:0 10px 25px rgba(2,6,23,.06)}
    .badge{border-radius:999px; padding:.25rem .6rem; font-weight:600}
    .stage-bg{background: radial-gradient(1200px 400px at 50% 0%, rgba(239,125,77,.08), transparent),
                          linear-gradient(180deg, rgba(0,0,0,.06), transparent 35%);}
    .btn{padding:.6rem 1rem; border-radius:.8rem}
  </style>
</head>
<body>
  <!-- 頁首／進度區 -->
  <header class="stage-bg">
    <div class="max-w-5xl mx-auto px-4 py-8 sm:py-10">
      <div class="flex items-center justify-between">
        <h1 class="text-2xl sm:text-3xl font-extrabold tracking-tight">八段錦 AI 闖關 — PWA</h1>
        <div class="flex items-center gap-2">
          <button id="btn-install" class="hidden px-3 py-2 text-sm rounded-lg bg-black text-white">安裝到手機</button>
          <button id="btn-reset" class="px-3 py-2 text-sm rounded-lg bg-slate-100 hover:bg-slate-200">重置進度</button>
        </div>
      </div>
      <p class="mt-2 text-slate-600 max-w-2xl">
        完成每一關指定姿勢，<span class="font-semibold">AI 自動判定</span>達到門檻即通關。此版本已修正
        <span class="font-semibold">「鏡頭開啟但不顯示人像」</span>問題（改用 TM 的 <code>webcam.canvas</code> 直接渲染）。
      </p>
      <div class="mt-6 bg-white card p-4">
        <div class="flex items-center justify-between">
          <div class="font-semibold">闖關進度</div>
          <div id="badges" class="flex flex-wrap gap-2"></div>
        </div>
        <div class="w-full h-3 bg-slate-100 rounded-full mt-2">
          <div id="progress" class="h-3 bg-orange-500 rounded-full transition-all" style="width:0%"></div>
        </div>
        <div id="map" class="grid grid-cols-2 sm:grid-cols-4 gap-3 mt-4"></div>
      </div>
    </div>
  </header>

  <!-- 主內容 -->
  <main class="max-w-5xl mx-auto px-4 pb-16">
    <!-- 說明卡 -->
    <section class="grid md:grid-cols-3 gap-4 mt-6">
      <div class="card p-4">
        <div class="text-sm uppercase tracking-wider text-slate-500">模式</div>
        <div class="mt-1 font-semibold">AI 自動判定</div>
        <p class="text-sm text-slate-600 mt-1">開啟鏡頭，完成指定八式之一；達到置信度門檻並連續維持即通關。</p>
      </div>
      <div class="card p-4">
        <div class="text-sm uppercase tracking-wider text-slate-500">設備建議</div>
        <div class="mt-1 font-semibold">手機直立 / 筆電鏡頭</div>
        <p class="text-sm text-slate-600 mt-1">背景簡潔、光線充足；避免逆光；穿著色塊分明。</p>
      </div>
      <div class="card p-4">
        <div class="text-sm uppercase tracking-wider text-slate-500">資料</div>
        <div class="mt-1 font-semibold">本機記錄</div>
        <p class="text-sm text-slate-600 mt-1">進度與成績僅存於瀏覽器 LocalStorage，可匯出 CSV（本檔未含匯出鈕）。</p>
      </div>
    </section>

    <!-- 關卡列表 -->
    <section id="levels" class="mt-6 grid md:grid-cols-2 gap-4"></section>

    <!-- AI 判定面板 -->
    <section id="panel" class="mt-6 card p-4 hidden">
      <div class="flex items-center justify-between">
        <div>
          <div id="panel-title" class="font-bold text-lg"></div>
          <p id="panel-desc" class="text-sm text-slate-600"></p>
        </div>
        <button id="btn-close" class="px-3 py-2 text-sm bg-slate-100 rounded-lg hover:bg-slate-200">關閉</button>
      </div>

      <div class="grid md:grid-cols-2 gap-4 mt-4">
        <div class="card p-3">
          <!-- 用來放 TM 的 webcam.canvas，避免某些瀏覽器 <video srcObject> 黑畫面 -->
          <div id="camBox" class="w-full rounded-xl overflow-hidden bg-black aspect-video"></div>
          <div class="flex items-center justify-between mt-2">
            <div class="text-sm">模型：<span id="model-name" class="font-semibold">未載入</span></div>
            <div class="text-sm">狀態：<span id="status" class="font-semibold">待機</span></div>
          </div>
        </div>
        <div class="card p-4">
          <div class="text-sm uppercase tracking-wider text-slate-500">即時結果</div>
          <div id="live-label" class="mt-2 text-2xl font-extrabold">—</div>
          <div id="meter" class="mt-3 h-2 bg-slate-100 rounded-full">
            <div id="meter-fill" class="h-2 bg-emerald-500 rounded-full transition-all" style="width:0%"></div>
          </div>
          <ul id="sequence-list" class="mt-4 space-y-2 text-sm"></ul>
          <div class="mt-4 flex gap-2">
            <button id="btn-start" class="px-4 py-2 bg-orange-600 text-white rounded-xl shadow hover:bg-orange-700">開始偵測</button>
            <button id="btn-stop" class="px-4 py-2 bg-slate-200 rounded-xl hover:bg-slate-300">停止</button>
          </div>
        </div>
      </div>
    </section>

    <!-- 音效（可替換或移除） -->
    <audio id="sfx-ok"  src="https://assets.mixkit.co/active_storage/sfx/2000/2000-preview.mp3"></audio>
    <audio id="sfx-bad" src="https://assets.mixkit.co/active_storage/sfx/2568/2568-preview.mp3"></audio>
    <audio id="sfx-win" src="https://assets.mixkit.co/active_storage/sfx/2013/2013-preview.mp3"></audio>
  </main>

  <footer class="text-center text-xs text-slate-500 py-10">© 2025 Baduanjin Missions</footer>

<script>
/* =========================
   1) 關卡 / 模型設定
   - 將 TM Pose 匯出的 model.json / metadata.json / weights.bin 放在 ./model/
   - metadata.json 的 labels 請使用 B1~B8 對應八式
========================= */
const CONFIG = {
  STORAGE_KEY: 'baduanjin_missions_pwa_v1',
  DEFAULT_MODEL_URL: './model/', // ←←← 你的模型資料夾
  LEVELS: [
    { id:'b1', title:'一、雙手托天理三焦', badge:'B1', desc:'手臂上托，身形中正，持續穩定。', mode:'single', expect:'B1', threshold:0.85, holdFrames:24 },
    { id:'b2', title:'二、左右開弓似射鵰', badge:'B2', desc:'左右張弓，目視箭隅。', mode:'single', expect:'B2', threshold:0.85, holdFrames:24 },
    { id:'b3', title:'三、調理脾胃須單舉', badge:'B3', desc:'一手上托一手下按，身體正直。', mode:'single', expect:'B3', threshold:0.85, holdFrames:24 },
    { id:'b4', title:'四、五勞七傷向後瞧', badge:'B4', desc:'頸項鬆沉，向後顧盼。', mode:'single', expect:'B4', threshold:0.85, holdFrames:24 },
    { id:'b5', title:'五、搖頭擺尾去心火', badge:'B5', desc:'腰胯協調、轉體穩定。', mode:'single', expect:'B5', threshold:0.85, holdFrames:24 },
    { id:'b6', title:'六、兩手攀足固腎腰', badge:'B6', desc:'屈伸協調，脊柱牽引。', mode:'single', expect:'B6', threshold:0.85, holdFrames:24 },
    { id:'b7', title:'七、攢拳怒目增氣力', badge:'B7', desc:'拳走弧線、沉肩墜肘。', mode:'single', expect:'B7', threshold:0.85, holdFrames:24 },
    { id:'b8', title:'八、背後七顛百病消', badge:'B8', desc:'腳跟輕顛、呼吸綿長。', mode:'single', expect:'B8', threshold:0.85, holdFrames:24 }
  ],
  BADGE_RULES: [
    { id:'silver', label:'銀牌', need:4 },
    { id:'gold', label:'金牌', need:6 },
    { id:'all', label:'滿貫', need:'ALL' }
  ]
};

/* =========================
   2) 本機進度（LocalStorage）
========================= */
let STATE = { model:null, labels:[], webcam:null, raf:null, running:false, currentLevel:null, holdCount:0 };
function loadProgress(){ try { return JSON.parse(localStorage.getItem(CONFIG.STORAGE_KEY)) || { cleared:[] }; } catch(e){ return { cleared:[] }; } }
function saveProgress(d){ localStorage.setItem(CONFIG.STORAGE_KEY, JSON.stringify(d)); }
function resetProgress(){ saveProgress({ cleared:[] }); renderProgress(); }

/* =========================
   3) UI 渲染
========================= */
const $levels = document.getElementById('levels');
const $map = document.getElementById('map');
const $progress = document.getElementById('progress');
const $badges = document.getElementById('badges');

function renderLevels(){
  const prog = loadProgress();
  $levels.innerHTML = '';
  CONFIG.LEVELS.forEach((lv,i)=>{
    const cleared = prog.cleared.includes(lv.id);
    const locked = i>0 && !prog.cleared.includes(CONFIG.LEVELS[i-1].id);
    const html = `
    <div class="card p-4">
      <div class="flex items-center justify-between">
        <div class="font-bold">${lv.title}</div>
        <span class="badge text-xs ${cleared? 'bg-emerald-100 text-emerald-700':'bg-slate-100 text-slate-700'}">${cleared? '已通關':'未通關'}</span>
      </div>
      <p class="mt-1 text-sm text-slate-600">${lv.desc}</p>
      <div class="mt-3 flex flex-wrap gap-2">
        <button class="btn text-white ${!locked? 'bg-orange-600 hover:bg-orange-700':'bg-slate-400 cursor-not-allowed'}"
                data-action="ai" data-id="${lv.id}" ${!locked? '':'disabled'}>AI 判定</button>
      </div>
      <div class="mt-3 text-xs text-slate-500">提示：第 ${i+1} 關通過後才會解鎖下一關。</div>
    </div>`;
    $levels.insertAdjacentHTML('beforeend', html);
  });
}

function renderMap(){
  const prog = loadProgress();
  $map.innerHTML = '';
  CONFIG.LEVELS.forEach((lv,i)=>{
    const cleared = prog.cleared.includes(lv.id);
    const html = `
      <div class="p-3 rounded-xl border ${cleared? 'border-emerald-300 bg-emerald-50':'border-slate-200 bg-white'}">
        <div class="text-xs text-slate-500">${i+1}</div>
        <div class="font-semibold">${lv.title.replace(/^一、|二、|三、|四、|五、|六、|七、|八、/,'')}</div>
      </div>`;
    $map.insertAdjacentHTML('beforeend', html);
  });
  const pct = Math.round((loadProgress().cleared.length/CONFIG.LEVELS.length)*100);
  $progress.style.width = pct + '%';
}

function renderBadges(){
  const c = loadProgress().cleared.length; $badges.innerHTML = '';
  CONFIG.BADGE_RULES.forEach(b=>{
    const ok = (b.need==='ALL') ? (c===CONFIG.LEVELS.length) : (c>=b.need);
    const node = document.createElement('span');
    node.className = `badge ${ok? 'bg-yellow-100 text-yellow-800':'bg-slate-100 text-slate-600'}`;
    node.textContent = ok ? `${b.label} ✓` : b.label;
    $badges.appendChild(node);
  });
}

function renderProgress(){ renderLevels(); renderMap(); renderBadges(); }

/* =========================
   4) 事件：清除、點關卡
========================= */
document.getElementById('btn-reset').addEventListener('click', ()=>{ if(confirm('確定要重置全部進度？')) resetProgress(); });
$levels.addEventListener('click', (e)=>{
  const btn = e.target.closest('button'); if(!btn) return;
  const id = btn.dataset.id; const action = btn.dataset.action;
  if(action==='ai') openPanel(id);
});

/* =========================
   5) 面板與模型載入（重點：使用 webcam.canvas）
========================= */
const $panel = document.getElementById('panel');
const $panelTitle = document.getElementById('panel-title');
const $panelDesc = document.getElementById('panel-desc');
const $btnClose = document.getElementById('btn-close');
const $liveLabel = document.getElementById('live-label');
const $meterFill = document.getElementById('meter-fill');
const $seqList = document.getElementById('sequence-list');
$btnClose.addEventListener('click', closePanel);

async function openPanel(levelId){
  const lv = CONFIG.LEVELS.find(x=>x.id===levelId); STATE.currentLevel = lv;
  $panelTitle.textContent = lv.title; $panelDesc.textContent = lv.desc; $panel.classList.remove('hidden');
  $seqList.innerHTML = `<li class="px-3 py-2 rounded-lg bg-slate-50">目標：${lv.expect}</li>`;
  await initModel(CONFIG.DEFAULT_MODEL_URL);
}
function closePanel(){ stopLoop(); $panel.classList.add('hidden'); }

async function initModel(modelURL){
  try{
    if(STATE.running) stopLoop();
    document.getElementById('model-name').textContent = modelURL;
    document.getElementById('status').textContent = '載入中…';
    const URL = modelURL.endsWith('/') ? modelURL : modelURL + '/';
    STATE.model = await tmPose.load(URL+'model.json', URL+'metadata.json');
    // STATE.labels = STATE.model.getClassLabels(); // 需要可再使用

    // ★★★ 關鍵修正：使用 TM 的 webcam.canvas 直接顯示，避免 <video>.srcObject 黑畫面 ★★★
    STATE.webcam = new tmPose.Webcam(400, 400, true);           // (w, h, flip)
    await STATE.webcam.setup({ facingMode: 'user' });            // 前鏡頭；後鏡頭改 'environment'
    STATE.webcam.webcam.setAttribute('playsinline', true);       // iOS 必要
    STATE.webcam.webcam.muted = true;
    await STATE.webcam.play();

    const box = document.getElementById('camBox');
    box.innerHTML = '';
    STATE.webcam.canvas.style.width = '100%';
    STATE.webcam.canvas.style.height = 'auto';
    box.appendChild(STATE.webcam.canvas);

    document.getElementById('status').textContent = '就緒';
    document.getElementById('btn-start').onclick = startLoop;
    document.getElementById('btn-stop').onclick = stopLoop;

    // PWA（可留可去）：https / localhost 下自動註冊 SW
    if ('serviceWorker' in navigator) {
      try { await navigator.serviceWorker.register('./sw.js'); } catch(e) { console.warn('SW 註冊失敗', e); }
    }
  }catch(err){
    console.error(err);
    alert('模型或鏡頭載入失敗，請檢查 URL / 權限');
    document.getElementById('status').textContent = '錯誤';
  }
}

/* =========================
   6) 推論循環與判定
========================= */
async function startLoop(){ if(!STATE.model||!STATE.webcam) return; STATE.running=true; STATE.holdCount=0; loop(); }
function stopLoop(){ STATE.running=false; if(STATE.raf) cancelAnimationFrame(STATE.raf); document.getElementById('status').textContent='已停止'; }

async function loop(){
  if(!STATE.running) return; STATE.webcam.update();
  const { posenetOutput } = await STATE.model.estimatePose(STATE.webcam.canvas);
  const prediction = await STATE.model.predict(posenetOutput);
  let best = { className:'—', probability:0 };
  prediction.forEach(p=>{ if(p.probability>best.probability) best=p; });
  $liveLabel.textContent = `${best.className} (${(best.probability*100|0)}%)`;
  $meterFill.style.width = Math.min(100, Math.round(best.probability*100)) + '%';
  handleJudge(best);
  STATE.raf = requestAnimationFrame(loop);
}

function handleJudge(best){
  const lv = STATE.currentLevel; if(!lv) return;
  if(best.className===lv.expect && best.probability>=lv.threshold){
    STATE.holdCount++;
    if(STATE.holdCount>=lv.holdFrames) return pass(lv.id);
  } else {
    STATE.holdCount = Math.max(0, STATE.holdCount-1);
  }
}

function pass(levelId){
  stopLoop();
  const prog = loadProgress(); if(!prog.cleared.includes(levelId)) prog.cleared.push(levelId); saveProgress(prog);
  document.getElementById('sfx-win').play();
  alert('恭喜通關！');
  renderProgress();
}

/* =========================
   7) PWA 安裝提示（可選）
========================= */
let deferredPrompt;
window.addEventListener('beforeinstallprompt', (e)=>{
  e.preventDefault(); deferredPrompt = e;
  const btn = document.getElementById('btn-install'); btn.classList.remove('hidden');
  btn.onclick = async () => { btn.disabled = true; if(deferredPrompt){ deferredPrompt.prompt(); await deferredPrompt.userChoice; deferredPrompt=null; } };
});

/* =========================
   8) 啟動
========================= */
renderProgress();
</script>
</body>
</html>
