# Build a full index.html with "incognito-safe" progress backup (export/import/share link)
from pathlib import Path

html = r"""<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>å…«æ®µéŒ¦ AI é—–é—œ â€” é€£çºŒé—–é—œï¼ˆå«ç„¡ç—•å‚™ä»½ï¼‰</title>
  <meta name="theme-color" content="#ef7d4d" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <link rel="manifest" href="manifest.webmanifest">
  <link rel="icon" href="assets/icons/icon-192.png" sizes="192x192">
  <link rel="apple-touch-icon" href="assets/icons/icon-192.png">
  <!-- ä¸Šç·šå¯æ”¹æˆæœ¬åœ°ç·¨è­¯ CSS ä»¥å… CDN å—é™ -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- AI -->
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@1.3.1/dist/tf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/pose@0.8/dist/teachablemachine-pose.min.js"></script>
  <style>
    :root { --ink:#0f172a; --paper:#f8fafc; --brand:#ef7d4d; --ok:#16a34a; --warn:#f59e0b; --danger:#ef4444; }
    body{background:var(--paper); color:var(--ink)}
    .card{background:#fff; border-radius:1rem; box-shadow:0 10px 25px rgba(2,6,23,.06)}
    .badge{border-radius:999px; padding:.25rem .6rem; font-weight:600}
    .stage-bg{background: radial-gradient(1200px 400px at 50% 0%, rgba(239,125,77,.08), transparent),
                          linear-gradient(180deg, rgba(0,0,0,.06), transparent 35%);}
    .btn{padding:.6rem 1rem; border-radius:.8rem}

    /* å…¨è¢å¹•æ”å½±ï¼ˆiOS å®‰å…¨å€ï¼‰ */
    body.fs { overflow:hidden; }
    body.fs #panel { position: fixed; inset: 0; z-index: 1000; background: #000;
      padding: env(safe-area-inset-top) 0 env(safe-area-inset-bottom); overflow: hidden; }
    body.fs #panel .grid { grid-template-columns: 1fr !important; }
    body.fs #camWrap { padding: 0 !important; background: #000 !important; }
    body.fs #camBox { width: 100%; height: 100dvh; height: 100vh; aspect-ratio: auto !important; max-height: none !important; border-radius: 0 !important; }
    body.fs #statCard { display: none; }
    .cam-canvas { width:100%; height:100%; display:block; }

    /* Toast / Overlay */
    #toast { position: fixed; top: 12px; left: 50%; transform: translateX(-50%); z-index: 2000; }
    #toast .box { background: #10b981; color: #fff; padding: .6rem 1rem; border-radius: .75rem; box-shadow: 0 10px 25px rgba(0,0,0,.15); }
    #overlay { position:fixed; inset:0; display:none; place-items:center; background:rgba(0,0,0,.45); z-index:1500; }
    #overlay .count { color:#fff; font-size: clamp(48px, 9vw, 88px); font-weight: 900; }

    /* ç„¡ç—•/æœªæŒä¹…å„²å­˜æç¤ºæ¢ */
    #persist-tip { display:none; }
    #persist-tip.show { display:block; }
  </style>
</head>
<body>
  <header class="stage-bg">
    <div class="max-w-5xl mx-auto px-4 py-8 sm:py-10">
      <div id="persist-tip" class="mb-3">
        <div class="rounded-xl bg-amber-50 border border-amber-200 px-3 py-2 text-amber-800 text-sm flex items-center justify-between gap-3">
          <div>âš ï¸ ç›®å‰è™•æ–¼ç„¡ç—•æˆ–æœªæŒä¹…å„²å­˜æ¨¡å¼ï¼šé—œé–‰è¦–çª—å¾Œé€²åº¦æœƒæ¶ˆå¤±ã€‚è«‹ç”¨ã€ŒåŒ¯å‡ºé€²åº¦ã€æˆ–ã€Œè¤‡è£½é€²åº¦é€£çµã€å‚™ä»½ã€‚</div>
          <button id="tip-close" class="text-amber-800/80 px-2 py-1 rounded hover:bg-amber-100">çŸ¥é“äº†</button>
        </div>
      </div>
      <div class="flex items-center justify-between">
        <h1 class="text-2xl sm:text-3xl font-extrabold tracking-tight">å…«æ®µéŒ¦ AI é—–é—œ â€” é€£çºŒé—–é—œ</h1>
        <div class="flex items-center gap-2">
          <button id="btn-install" class="hidden px-3 py-2 text-sm rounded-lg bg-black text-white">å®‰è£</button>
          <button id="btn-export" class="px-3 py-2 text-sm rounded-lg bg-slate-900 text-white">åŒ¯å‡º</button>
          <label for="file-import" class="px-3 py-2 text-sm rounded-lg bg-slate-100 hover:bg-slate-200 cursor-pointer">åŒ¯å…¥</label>
          <input id="file-import" type="file" accept="application/json" class="hidden">
          <button id="btn-link" class="px-3 py-2 text-sm rounded-lg bg-emerald-600 text-white">è¤‡è£½é€²åº¦é€£çµ</button>
          <button id="btn-reset" class="px-3 py-2 text-sm rounded-lg bg-slate-100 hover:bg-slate-200">é‡ç½®</button>
        </div>
      </div>
      <p class="mt-2 text-slate-600 max-w-2xl">é è¨­ã€Œè‡ªå‹•é€£çºŒæ¨¡å¼ã€ï¼šé€šé—œå¾Œè‡ªå‹•å€’æ•¸â†’ä¸‹ä¸€å¼â†’è‡ªå‹•çºŒè·‘ã€‚</p>
      <div class="mt-4 bg-white card p-4">
        <div class="flex items-center justify-between">
          <div class="font-semibold">é—–é—œé€²åº¦</div>
          <div id="badges" class="flex flex-wrap gap-2"></div>
        </div>
        <div class="w-full h-3 bg-slate-100 rounded-full mt-2">
          <div id="progress" class="h-3 bg-orange-500 rounded-full transition-all" style="width:0%"></div>
        </div>
        <div id="map" class="grid grid-cols-2 sm:grid-cols-4 gap-3 mt-4"></div>
      </div>
    </div>
  </header>

  <main class="max-w-5xl mx-auto px-4 pb-16">
    <section id="levels" class="mt-6 grid md:grid-cols-2 gap-4"></section>

    <section id="panel" class="mt-6 card p-4 hidden">
      <div class="panel-head flex flex-wrap items-center justify-between gap-2">
        <div>
          <div id="panel-title" class="font-bold text-lg"></div>
          <p id="panel-desc" class="text-sm text-slate-600"></p>
        </div>
        <div class="flex items-center gap-2">
          <label class="flex items-center gap-2 text-sm">
            <input id="auto-run" type="checkbox" class="accent-orange-600" checked>
            <span>è‡ªå‹•é€£çºŒ</span>
          </label>
          <button id="btn-switch" class="px-3 py-2 text-sm bg-slate-800 text-white rounded-lg">åˆ‡æ›å‰/å¾Œé¡é ­</button>
          <button id="btn-full" class="px-3 py-2 text-sm bg-black text-white rounded-lg">å…¨è¢å¹•</button>
          <button id="btn-close" class="px-3 py-2 text-sm bg-slate-100 rounded-lg hover:bg-slate-200">é—œé–‰</button>
        </div>
      </div>

      <div class="grid md:grid-cols-2 gap-4 mt-4">
        <div id="camWrap" class="card p-3">
          <div id="camBox" class="w-full rounded-xl overflow-hidden bg-black" style="aspect-ratio: 9 / 16; max-height: 80vh;"></div>
          <div class="flex items-center justify-between mt-2">
            <div class="text-sm">æ¨¡å‹ï¼š<span id="model-name" class="font-semibold">æœªè¼‰å…¥</span></div>
            <div class="text-sm">ç‹€æ…‹ï¼š<span id="status" class="font-semibold">å¾…æ©Ÿ</span></div>
          </div>
        </div>

        <div id="statCard" class="card p-4">
          <div class="text-sm uppercase tracking-wider text-slate-500">å³æ™‚çµæœï¼ˆæœ¬é—œï¼‰</div>
          <div id="live-label" class="mt-2 text-2xl font-extrabold">â€”</div>
          <div id="meter" class="mt-3 h-2 bg-slate-100 rounded-full"><div id="meter-fill" class="h-2 bg-emerald-500 rounded-full transition-all" style="width:0%"></div></div>
          <ul id="sequence-list" class="mt-4 space-y-2 text-sm"></ul>
          <div class="mt-4 flex flex-wrap gap-2">
            <button id="btn-start" class="px-4 py-2 bg-orange-600 text-white rounded-xl shadow hover:bg-orange-700">é–‹å§‹åµæ¸¬</button>
            <button id="btn-stop" class="px-4 py-2 bg-slate-200 rounded-xl hover:bg-slate-300">åœæ­¢</button>
            <button id="btn-next" class="px-4 py-2 bg-emerald-600 text-white rounded-xl hover:bg-emerald-700">ä¸‹ä¸€æ‹›</button>
            <button id="btn-redo" class="px-4 py-2 bg-indigo-600 text-white rounded-xl hover:bg-indigo-700">é‡åšæœ¬æ‹›</button>
          </div>
        </div>
      </div>
    </section>

    <audio id="sfx-win" src="https://assets.mixkit.co/active_storage/sfx/2013/2013-preview.mp3"></audio>
    <div id="toast" class="hidden"><div class="box" id="toast-text">æ­å–œé€šé—œï¼</div></div>
    <div id="overlay"><div class="count" id="countdown">3</div></div>
  </main>

  <footer class="text-center text-xs text-slate-500 py-10">Â© 2025 Baduanjin Missions</footer>

<script>
/* ========= è¨­å®š ========= */
const CONFIG = {
  STORAGE_KEY: 'baduanjin_missions_pwa_v7',
  DEFAULT_MODEL_URL: './model/',
  CAMERA: { width: 360, height: 640, flip: true }, // facing æ”¹ç”± STATE æ§åˆ¶
  LEVELS: [
    { id:'b1', title:'ä¸€ã€é›™æ‰‹æ‰˜å¤©ç†ä¸‰ç„¦', badge:'B1', desc:'æ‰‹è‡‚ä¸Šæ‰˜ï¼Œèº«å½¢ä¸­æ­£ï¼ŒæŒçºŒç©©å®šã€‚', expect:'B1', threshold:0.85, holdFrames:24 },
    { id:'b2', title:'äºŒã€å·¦å³é–‹å¼“ä¼¼å°„éµ°', badge:'B2', desc:'å·¦å³å¼µå¼“ï¼Œç›®è¦–ç®­éš…ã€‚',             expect:'B2', threshold:0.85, holdFrames:24 },
    { id:'b3', title:'ä¸‰ã€èª¿ç†è„¾èƒƒé ˆå–®èˆ‰', badge:'B3', desc:'ä¸€æ‰‹ä¸Šæ‰˜ä¸€æ‰‹ä¸‹æŒ‰ï¼Œèº«é«”æ­£ç›´ã€‚',       expect:'B3', threshold:0.85, holdFrames:24 },
    { id:'b4', title:'å››ã€äº”å‹ä¸ƒå‚·å‘å¾Œç§', badge:'B4', desc:'é ¸é …é¬†æ²‰ï¼Œå‘å¾Œé¡§ç›¼ã€‚',               expect:'B4', threshold:0.85, holdFrames:24 },
    { id:'b5', title:'äº”ã€æ–é ­æ“ºå°¾å»å¿ƒç«', badge:'B5', desc:'è…°èƒ¯å”èª¿ã€è½‰é«”ç©©å®šã€‚',               expect:'B5', threshold:0.85, holdFrames:24 },
    { id:'b6', title:'å…­ã€å…©æ‰‹æ”€è¶³å›ºè…è…°', badge:'B6', desc:'å±ˆä¼¸å”èª¿ï¼Œè„ŠæŸ±ç‰½å¼•ã€‚',               expect:'B6', threshold:0.85, holdFrames:24 },
    { id:'b7', title:'ä¸ƒã€æ”¢æ‹³æ€’ç›®å¢æ°£åŠ›', badge:'B7', desc:'æ‹³èµ°å¼§ç·šã€æ²‰è‚©å¢œè‚˜ã€‚',               expect:'B7', threshold:0.85, holdFrames:24 },
    { id:'b8', title:'å…«ã€èƒŒå¾Œä¸ƒé¡›ç™¾ç—…æ¶ˆ', badge:'B8', desc:'è…³è·Ÿè¼•é¡›ã€å‘¼å¸ç¶¿é•·ã€‚',               expect:'B8', threshold:0.85, holdFrames:24 }
  ],
  LABEL_ALIASES: {
    B1: ['B1','D1','é›™æ‰‹æ‰˜å¤©ç†ä¸‰ç„¦','æ‰˜å¤©'],
    B2: ['B2','D2','å·¦å³é–‹å¼“','å°„éµ°'],
    B3: ['B3','D3','èª¿ç†è„¾èƒƒ','å–®èˆ‰'],
    B4: ['B4','D4','äº”å‹ä¸ƒå‚·','å‘å¾Œç§'],
    B5: ['B5','D5','æ–é ­æ“ºå°¾','å»å¿ƒç«'],
    B6: ['B6','D6','å…©æ‰‹æ”€è¶³','å›ºè…è…°'],
    B7: ['B7','D7','æ”¢æ‹³æ€’ç›®','å¢æ°£åŠ›'],
    B8: ['B8','D8','èƒŒå¾Œä¸ƒé¡›','ç™¾ç—…æ¶ˆ']
  ],
  BADGE_RULES: [
    { id:'silver', label:'éŠ€ç‰Œ', need:4 },
    { id:'gold', label:'é‡‘ç‰Œ', need:6 },
    { id:'all', label:'æ»¿è²«', need:'ALL' }
  ]
};

/* ========= ç‹€æ…‹ ========= */
let STATE = {
  model:null, labels:[], webcam:null, ctx:null, raf:null, running:false,
  currentLevel:null, holdCount:0, expected:null, cameraFacing:'user'
};

/* ========= Progress å„²å­˜ï¼ˆé™„å‚™æ´ï¼‰ ========= */
function safeIds(arr){
  const valid = new Set(CONFIG.LEVELS.map(l=>l.id));
  return (arr||[]).filter(x=> valid.has(x));
}
function loadProgress(){
  try { return JSON.parse(localStorage.getItem(CONFIG.STORAGE_KEY)) || { cleared:[] }; }
  catch(e){ return { cleared:[] }; }
}
function saveProgress(d){
  try { localStorage.setItem(CONFIG.STORAGE_KEY, JSON.stringify(d)); } catch(e){ /* ç„¡ç—•å¯èƒ½ä¸ŸéŒ¯ä¹Ÿæ²’é—œä¿‚ */ }
}

function applyHashProgress(){
  const m = location.hash.match(/(?:^#|&)p=([^&]+)/);
  if(!m) return;
  try{
    const list = decodeURIComponent(m[1]).split(',').filter(Boolean);
    const merged = Array.from(new Set([...(loadProgress().cleared||[]), ...safeIds(list)]));
    saveProgress({ cleared: merged });
  }catch(e){}
}
async function checkPersistenceTip(){
  try{
    if (navigator.storage && navigator.storage.persisted) {
      const ok = await navigator.storage.persisted();
      if (!ok) document.getElementById('persist-tip').classList.add('show');
    }
  }catch(e){ /* å¿½ç•¥ */ }
}

/* ========= UI ========= */
const $levels = document.getElementById('levels');
const $map = document.getElementById('map');
const $progress = document.getElementById('progress');
const $badges = document.getElementById('badges');
const $panel = document.getElementById('panel');
const $panelTitle = document.getElementById('panel-title');
const $panelDesc = document.getElementById('panel-desc');
const $btnClose = document.getElementById('btn-close');
const $btnFull  = document.getElementById('btn-full');
const $btnSwitch= document.getElementById('btn-switch');
const $btnStart = document.getElementById('btn-start');
const $btnStop  = document.getElementById('btn-stop');
const $btnNext  = document.getElementById('btn-next');
const $btnRedo  = document.getElementById('btn-redo');
const $autoRun  = document.getElementById('auto-run');
const $liveLabel= document.getElementById('live-label');
const $meterFill= document.getElementById('meter-fill');
const $seqList  = document.getElementById('sequence-list');
const $toast    = document.getElementById('toast');
const $toastText= document.getElementById('toast-text');
const $overlay  = document.getElementById('overlay');
const $countdown= document.getElementById('countdown');
const $tipClose = document.getElementById('tip-close');

document.getElementById('btn-reset').addEventListener('click', ()=>{ if(confirm('ç¢ºå®šè¦é‡ç½®å…¨éƒ¨é€²åº¦ï¼Ÿ')) { saveProgress({cleared:[]}); renderProgress(); }});
document.getElementById('btn-export').addEventListener('click', ()=>{
  const data = { v:1, cleared: safeIds(loadProgress().cleared), ts: Date.now() };
  const blob = new Blob([JSON.stringify(data,null,2)], {type:'application/json'});
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'baduanjin_progress.json'; a.click();
  setTimeout(()=> URL.revokeObjectURL(a.href), 1000);
});
document.getElementById('file-import').addEventListener('change', async (e)=>{
  const f = e.target.files?.[0]; if(!f) return;
  try{
    const txt = await f.text();
    const obj = JSON.parse(txt);
    if(!obj || !Array.isArray(obj.cleared)) throw new Error('æ ¼å¼ä¸ç¬¦');
    saveProgress({ cleared: safeIds(obj.cleared) });
    renderProgress();
    toast('âœ… é€²åº¦å·²åŒ¯å…¥');
  }catch(err){
    alert('åŒ¯å…¥å¤±æ•—ï¼š' + (err.message||err));
  }finally{ e.target.value=''; }
});
document.getElementById('btn-link').addEventListener('click', async ()=>{
  const cleared = safeIds(loadProgress().cleared);
  const url = location.origin + location.pathname + '#p=' + encodeURIComponent(cleared.join(','));
  try{
    await navigator.clipboard.writeText(url);
    toast('ğŸ”— é€²åº¦é€£çµå·²è¤‡è£½');
  }catch{ prompt('è¤‡è£½ä¸‹é¢çš„é€£çµ', url); }
});
$tipClose.addEventListener('click', ()=> document.getElementById('persist-tip').classList.remove('show'));

function renderLevels(){
  const prog = loadProgress();
  $levels.innerHTML = '';
  CONFIG.LEVELS.forEach((lv,i)=>{
    const cleared = prog.cleared.includes(lv.id);
    const locked = i>0 && !prog.cleared.includes(CONFIG.LEVELS[i-1].id);
    const html = `
    <div class="card p-4">
      <div class="flex items-center justify-between">
        <div class="font-bold">${lv.title}</div>
        <span class="badge text-xs ${cleared? 'bg-emerald-100 text-emerald-700':'bg-slate-100 text-slate-700'}">${cleared? 'å·²é€šé—œ':'æœªé€šé—œ'}</span>
      </div>
      <p class="mt-1 text-sm text-slate-600">${lv.desc}</p>
      <div class="mt-3 flex flex-wrap gap-2">
        <button class="btn text-white ${!locked? 'bg-orange-600 hover:bg-orange-700':'bg-slate-400 cursor-not-allowed'}" data-action="ai" data-id="${lv.id}" ${!locked? '':'disabled'}>AI åˆ¤å®š</button>
      </div>
      <div class="mt-3 text-xs text-slate-500">æç¤ºï¼šç¬¬ ${i+1} é—œé€šéå¾Œè§£é–ä¸‹ä¸€é—œã€‚</div>
    </div>`;
    $levels.insertAdjacentHTML('beforeend', html);
  });
}
function renderMap(){
  const prog = loadProgress();
  $map.innerHTML = '';
  CONFIG.LEVELS.forEach((lv,i)=>{
    const cleared = prog.cleared.includes(lv.id);
    const html = `
      <div class="p-3 rounded-xl border ${cleared? 'border-emerald-300 bg-emerald-50':'border-slate-200 bg-white'}">
        <div class="text-xs text-slate-500">${i+1}</div>
        <div class="font-semibold">${lv.title.replace(/^ä¸€ã€|äºŒã€|ä¸‰ã€|å››ã€|äº”ã€|å…­ã€|ä¸ƒã€|å…«ã€/,'')}</div>
      </div>`;
    $map.insertAdjacentHTML('beforeend', html);
  });
  const pct = Math.round((loadProgress().cleared.length/CONFIG.LEVELS.length)*100);
  $progress.style.width = pct + '%';
}
function renderBadges(){
  const c = loadProgress().cleared.length; $badges.innerHTML = '';
  CONFIG.BADGE_RULES.forEach(b=>{
    const ok = (b.need==='ALL') ? (c===CONFIG.LEVELS.length) : (c>=b.need);
    const node = document.createElement('span');
    node.className = `badge ${ok? 'bg-yellow-100 text-yellow-800':'bg-slate-100 text-slate-600'}`;
    node.textContent = ok ? `${b.label} âœ“` : b.label;
    $badges.appendChild(node);
  });
}
function renderProgress(){ renderLevels(); renderMap(); renderBadges(); }

/* ========= é—–é—œäº’å‹• ========= */
$levels.addEventListener('click', (e)=>{
  const btn = e.target.closest('button'); if(!btn) return;
  const id = btn.dataset.id; const action = btn.dataset.action;
  if(action==='ai') openPanel(id);
});
$btnClose.addEventListener('click', closePanel);
$btnFull.addEventListener('click', ()=> { const fs = document.body.classList.toggle('fs'); $btnFull.textContent = fs ? 'é€€å‡ºå…¨è¢å¹•' : 'å…¨è¢å¹•'; });
$btnStart.addEventListener('click', ()=> startLoop());
$btnStop.addEventListener('click', ()=> stopLoop());
$btnNext.addEventListener('click', ()=> gotoNext());
$btnRedo.addEventListener('click', ()=> redoCurrent());
$btnSwitch.addEventListener('click', switchCamera);

/* ========= å°å·¥å…· ========= */
function toast(msg='å®Œæˆï¼', ms=1600, color='#10b981'){
  $toastText.textContent = msg;
  $toast.querySelector('.box').style.background = color;
  $toast.classList.remove('hidden');
  setTimeout(()=> $toast.classList.add('hidden'), ms);
}
function vibrate(pattern=[80]){ if (navigator.vibrate) try{ navigator.vibrate(pattern); }catch{} }
function showCountdown(n=2){
  $overlay.style.display = 'grid';
  let t = n;
  $countdown.textContent = t;
  const timer = setInterval(()=>{
    t -= 1; $countdown.textContent = t;
    if(t<=0){ clearInterval(timer); $overlay.style.display = 'none'; }
  }, 1000);
}

/* ========= æ¨¡å‹ / é¢æ¿ ========= */
function normalize(s){ return (s||'').toLowerCase().replace(/\s+/g,''); }
function resolveExpectedLabel(lv){
  const labels = STATE.labels || [];
  if (labels.includes(lv.expect)) return lv.expect;
  const aliases = CONFIG.LABEL_ALIASES[lv.badge] || CONFIG.LABEL_ALIASES[lv.expect] || [];
  const nAliases = aliases.map(normalize);
  for (const lab of labels){ const nLab = normalize(lab); if (nAliases.some(a=> nLab.includes(a))) return lab; }
  const idx = CONFIG.LEVELS.findIndex(x=>x.id===lv.id)+1;
  const byD = labels.find(l => normalize(l).includes('d'+idx));
  return byD || lv.expect;
}

async function openPanel(levelId){
  const lv = CONFIG.LEVELS.find(x=>x.id===levelId);
  STATE.currentLevel = lv;
  $panelTitle.textContent = lv.title;
  $panelDesc.textContent = lv.desc;
  $panel.classList.remove('hidden');
  $seqList.innerHTML = `<li class="px-3 py-2 rounded-lg bg-slate-50">é—œå¡ï¼š${lv.title}</li>`;

  if (!STATE.model) await initModel(CONFIG.DEFAULT_MODEL_URL);
  STATE.expected = resolveExpectedLabel(lv);
  $seqList.innerHTML = `
    <li class="px-3 py-2 rounded-lg bg-slate-50">é—œå¡ï¼š${lv.title}</li>
    <li class="px-3 py-2 rounded-lg bg-emerald-50">æ¨¡å‹æ¨™ç±¤ï¼š<b>${STATE.expected}</b></li>`;

  if (document.getElementById('auto-run').checked) startLoop();
}

function closePanel(){ stopLoop(); document.body.classList.remove('fs'); $panel.classList.add('hidden'); }

async function initModel(modelURL){
  try{
    stopLoop();
    document.getElementById('model-name').textContent = modelURL;
    document.getElementById('status').textContent = 'è¼‰å…¥ä¸­â€¦';
    const URL = modelURL.endsWith('/') ? modelURL : modelURL + '/';
    STATE.model = await tmPose.load(URL+'model.json', URL+'metadata.json');
    STATE.labels = STATE.model.getClassLabels();

    const { width, height, flip } = CONFIG.CAMERA;
    STATE.webcam = new tmPose.Webcam(width, height, flip);

    if (location.protocol !== 'https:' && location.hostname !== 'localhost') {
      alert('è«‹ç”¨ HTTPSï¼ˆæˆ– localhostï¼‰é–‹å•Ÿï¼Œæ‰‹æ©Ÿæ‰å…è¨±ç›¸æ©Ÿã€‚');
      throw new Error('Insecure context');
    }
    await STATE.webcam.setup({ facingMode: STATE.cameraFacing });
    STATE.webcam.webcam.setAttribute('playsinline', true);
    STATE.webcam.webcam.setAttribute('autoplay','true');
    STATE.webcam.webcam.muted = true;
    await STATE.webcam.play();

    const box = document.getElementById('camBox');
    box.innerHTML = '';
    STATE.webcam.canvas.className = 'cam-canvas';
    box.appendChild(STATE.webcam.canvas);
    STATE.ctx = STATE.webcam.canvas.getContext('2d');

    document.getElementById('status').textContent = 'å°±ç·’';
  }catch(err){
    console.error(err);
    const msg = (err && err.name) ? err.name : err;
    if (msg === 'NotAllowedError')      alert('ç›¸æ©Ÿæ¬Šé™è¢«æ‹’ã€‚è«‹åˆ°ç€è¦½å™¨ç¶²ç«™è¨­å®šå…è¨±ç›¸æ©Ÿï¼Œå†é‡æ•´ã€‚');
    else if (msg === 'NotFoundError' || msg === 'OverconstrainedError') alert('æ‰¾ä¸åˆ°é¡é ­ã€‚è«‹æŒ‰ã€Œåˆ‡æ›å‰/å¾Œé¡é ­ã€æˆ–æ”¹ç”¨å¦ä¸€ç€è¦½å™¨å†è©¦ã€‚');
    else if (msg !== 'Insecure context') alert('æ¨¡å‹æˆ–é¡é ­è¼‰å…¥å¤±æ•—ï¼š' + msg);
    document.getElementById('status').textContent = 'éŒ¯èª¤';
  }
}

/* ========= åµæ¸¬å¾ªç’° ========= */
async function startLoop(){ if(!STATE.model||!STATE.webcam) return; if(STATE.running) return; STATE.running=true; STATE.holdCount=0; loop(); }
function stopLoop(){ STATE.running=false; if(STATE.raf) cancelAnimationFrame(STATE.raf); document.getElementById('status').textContent='å·²åœæ­¢'; }

function drawCover(){
  const video = STATE.webcam.webcam;
  const can = STATE.webcam.canvas;
  const ctx = STATE.ctx;
  const cw = can.width, ch = can.height;
  const vw = video.videoWidth || cw, vh = video.videoHeight || ch;
  const scale = Math.max(cw / vw, ch / vh);
  const dw = vw * scale, dh = vh * scale;
  const dx = (cw - dw) / 2, dy = (ch - dh) / 2;
  ctx.save();
  if (STATE.webcam.flip){ ctx.translate(cw,0); ctx.scale(-1,1); }
  ctx.drawImage(video, dx, dy, dw, dh);
  ctx.restore();
}

async function loop(){
  if(!STATE.running) return;
  drawCover();
  const { posenetOutput } = await STATE.model.estimatePose(STATE.webcam.canvas);
  const prediction = await STATE.model.predict(posenetOutput);

  const lv = STATE.currentLevel;
  const expect = STATE.expected || lv.expect;
  const expPred = prediction.find(p => p.className === expect) || { probability: 0 };

  document.getElementById('live-label').textContent = `${lv.title} ${(expPred.probability*100|0)}%`;
  document.getElementById('meter-fill').style.width = Math.min(100, Math.round(expPred.probability*100)) + '%';

  if(expPred.probability >= lv.threshold){
    STATE.holdCount++;
    if(STATE.holdCount >= lv.holdFrames) return pass(lv.id);
  }else{
    STATE.holdCount = Math.max(0, STATE.holdCount-1);
  }
  STATE.raf = requestAnimationFrame(loop);
}

function pass(levelId){
  const prog = loadProgress();
  if(!prog.cleared.includes(levelId)) { prog.cleared.push(levelId); saveProgress(prog); renderProgress(); }
  document.getElementById('sfx-win').play();
  vibrate([60, 40, 60]);
  toast('âœ… é€šé—œï¼', 1200, '#10b981');

  const idx = CONFIG.LEVELS.findIndex(l => l.id === levelId);
  const next = CONFIG.LEVELS[idx+1];
  if (document.getElementById('auto-run').checked && next){
    showCountdown(2);
    setTimeout(()=> gotoLevel(next), 2000);
  } else if (!next) {
    toast('ğŸ‰ å…¨éƒ¨å®Œæˆï¼', 2000, '#f59e0b'); stopLoop();
  } else { stopLoop(); }
}

/* ========= é—œå¡åˆ‡æ› ========= */
function gotoLevel(lv){
  STATE.currentLevel = lv;
  STATE.expected = resolveExpectedLabel(lv);
  $panelTitle.textContent = lv.title;
  $panelDesc.textContent = lv.desc;
  $seqList.innerHTML = `
    <li class="px-3 py-2 rounded-lg bg-slate-50">é—œå¡ï¼š${lv.title}</li>
    <li class="px-3 py-2 rounded-lg bg-emerald-50">æ¨¡å‹æ¨™ç±¤ï¼š<b>${STATE.expected}</b></li>`;
  STATE.holdCount = 0;
  if (document.getElementById('auto-run').checked) startLoop();
}
function gotoNext(){
  if(!STATE.currentLevel) return;
  const idx = CONFIG.LEVELS.findIndex(l=> l.id===STATE.currentLevel.id);
  const next = CONFIG.LEVELS[idx+1];
  if (next) gotoLevel(next); else toast('å·²æ˜¯æœ€å¾Œä¸€æ‹›', 1200, '#f59e0b');
}
function redoCurrent(){
  if(!STATE.currentLevel) return;
  STATE.holdCount = 0;
  toast('é‡æ–°é–‹å§‹æœ¬æ‹›', 800, '#6366f1');
  if (document.getElementById('auto-run').checked) startLoop();
}

/* ========= é¡é ­åˆ‡æ› ========= */
async function switchCamera(){
  try{
    if (STATE.webcam && STATE.webcam.webcam && STATE.webcam.webcam.srcObject) {
      STATE.webcam.webcam.srcObject.getTracks().forEach(t => t.stop());
    }
    STATE.cameraFacing = (STATE.cameraFacing === 'user') ? 'environment' : 'user';
    await STATE.webcam.setup({ facingMode: STATE.cameraFacing });
    STATE.webcam.webcam.setAttribute('playsinline', true);
    STATE.webcam.webcam.setAttribute('autoplay', 'true');
    STATE.webcam.webcam.muted = true;
    await STATE.webcam.play();
  }catch(e){
    console.error('åˆ‡æ›é¡é ­å¤±æ•—ï¼š', e);
    alert('åˆ‡æ›é¡é ­å¤±æ•—ï¼Œè«‹ç¢ºèªç€è¦½å™¨å·²å…è¨±ç›¸æ©Ÿï¼Œæˆ–æ”¹ç”¨å¦ä¸€å€‹ç€è¦½å™¨é–‹å•Ÿã€‚');
  }
}

/* ========= PWAï¼ˆç©©å¥è¨»å†Šï¼‰ ========= */
async function registerSW() {
  if (!('serviceWorker' in navigator)) return;
  try {
    const base = location.pathname.endsWith('/') ? location.pathname : location.pathname.replace(/[^\/]+$/, '');
    const swPath = base + 'sw.js';
    await navigator.serviceWorker.register(swPath, { scope: base });
  } catch (e) { console.warn('SW è¨»å†Šå¤±æ•—', e); }
}
document.addEventListener('DOMContentLoaded', registerSW);

/* ========= å®‰è£æç¤ºï¼ˆå¯é¸ï¼‰ ========= */
let deferredPrompt;
window.addEventListener('beforeinstallprompt', (e)=>{
  e.preventDefault(); deferredPrompt = e;
  const btn = document.getElementById('btn-install'); btn.classList.remove('hidden');
  btn.onclick = async () => { btn.disabled = true; if(deferredPrompt){ deferredPrompt.prompt(); await deferredPrompt.userChoice; deferredPrompt=null; } };
});

/* ========= å•Ÿå‹• ========= */
applyHashProgress();
renderProgress();
checkPersistenceTip();
</script>
</body>
</html>
"""
p = Path("/mnt/data/index_incognito_ready.html")
p.write_text(html, encoding="utf-8")
print(str(p))
